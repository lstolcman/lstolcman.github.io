<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.122.0"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://lstolcman.github.io/post/cache-em-all-sppedd-up-apt-pip-docker/"><link rel=canonical href=https://lstolcman.github.io/post/cache-em-all-sppedd-up-apt-pip-docker/><link rel=alternate type=application/atom+xml href=https://lstolcman.github.ioindex.xml title="lstolcman Today-I-Learned"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lstolcman.github.io"},"articleSection":"post","name":"Cache\u0027em all! - speeding up apt and other downloads in (not only) docker containers (2024 version)","headline":"Cache\u0027em all! - speeding up apt and other downloads in (not only) docker containers (2024 version)","description":"When working on couple of DockerfilesContainerfiles, I was having a situation when I had to clear dockerpodman cache (for various reasons), and the indispensable step is to update or download certain packages from apt. It is often long process, and I was thinking whether there\u0026rsquo;s a way to speed it up or optimize.\nThe results of the investigation are below:\nCaching apt get downloads There are two options of caching:","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2024","datePublished":"2024-02-12 23:07:00 \u002b0200 \u002b0200","dateModified":"2024-02-12 23:07:00 \u002b0200 \u002b0200","url":"https:\/\/lstolcman.github.io\/post\/cache-em-all-sppedd-up-apt-pip-docker\/","keywords":["python","apt","pip","docker","podman"]}</script><title>Cache'em all! - speeding up apt and other downloads in (not only) docker containers (2024 version)</title>
<meta property="og:title" content="Cache'em all! - speeding up apt and other downloads in (not only) docker containers (2024 version)"><meta property="og:type" content="article"><meta property="og:description" content="When working on couple of DockerfilesContainerfiles, I was having a situation when I had to clear dockerpodman cache (for various reasons), and the indispensable step is to update or download certain packages from apt. It is often long process, and I was thinking whether there&amp;rsquo;s a way to speed it up or optimize.
The results of the investigation are below:
Caching apt get downloads There are two options of caching:"><meta name=description content="When working on couple of DockerfilesContainerfiles, I was having a situation when I had to clear dockerpodman cache (for various reasons), and the indispensable step is to update or download certain packages from apt. It is often long process, and I was thinking whether there&amp;rsquo;s a way to speed it up or optimize.
The results of the investigation are below:
Caching apt get downloads There are two options of caching:"><meta property="og:locale" content="en-us"><style>body{font-family:bree serif,sans-serif;-webkit-font-smoothing:antialiased;margin:0 20px}article{max-width:800px;margin-left:auto;margin-right:auto}a{color:#000;text-decoration:none}a:hover{font-weight:600;text-decoration:underline}.post-ads{margin:50px 0}.markdown-body{font-size:18px;max-width:100%}.markdown-body a{text-decoration:underline;text-decoration-color:#000}.markdown-body pre{padding:16px;overflow:auto;border-radius:10px}.markdown-body code{padding:.2em .4em;font-size:85%;background-color:#f6f8fa;border-radius:6px}.markdown-body pre>code{padding:0;font-size:100%;background-color:inherit;border:0}.Chinese .markdown-body{line-height:200%}.site-date-catalog{font-size:2rem}.header-title{font-size:2rem;font-weight:700;margin-top:32px;font-family:bungee shade,sans-serif}.header-title a{text-decoration:none}.header-subtitle{color:#666}.header-items{margin:10px 0}.header-item{margin:0 5px}.header-line{width:100%;border-width:2px;border-color:#482936;border-style:solid none none none}.lang-switch{font-weight:600}#posts-list{min-height:600px}.posts-line{font-size:1.2rem;margin:12px 0}.posts-categories{font-size:.8rem;margin:auto;text-align:center}.posts-category{padding:3px 0;border:#000 2px solid;border-radius:5px}.site-footer{margin-top:50px}.site-footer-item{margin-right:12px}.post-content img{max-width:100%;display:block;margin-right:auto;margin-top:12px}.post-header{margin-bottom:50px}.post-title{font-size:2rem;font-weight:600}.post-tags{display:inline;font-weight:600;padding:2px 5px;margin-right:6px;border:#000 2px solid;border-radius:5px}.post-date{font-weight:800;font-style:italic}.post-author{float:right;font-weight:600}.page-content{min-height:60%}.post-content{margin-bottom:50px}.post-content p{hyphens:auto;line-height:1.8;text-justify:ideographic;margin-bottom:1em}.related-content{border-width:3px;border-style:solid;border-color:#000;padding:0 10px;margin-bottom:50px;margin-top:100px}.related-content li{margin:5px 0}.taxonomy-term{font-size:3rem}.gallery-img{text-align:center}.gallery-img span{text-align:center}.gallery-img-desc{font-size:.8em;font-weight:800}#disqus_thread{position:relative}#disqus_thread:after{content:"";display:block;height:55px;width:100%;position:absolute;bottom:0;background:#fff}@media screen and (max-width:600px){.header-title,.header-subtitle,.header-items{text-align:center}.posts-line{font-size:16px}.markdown-body{font-size:16px}.post-title{font-size:2rem}.post-content p{letter-spacing:.05em}}@media screen and (max-width:48em){.posts-category{display:none}}</style><style>.container,.container-fluid{margin-right:auto;margin-left:auto}.container-fluid{padding-right:2rem;padding-left:2rem}.row{box-sizing:border-box;display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-flex:0;-ms-flex:0 1 auto;flex:initial;-webkit-box-orient:horizontal;-webkit-box-direction:normal;-ms-flex-direction:row;flex-direction:row;-ms-flex-wrap:wrap;flex-wrap:wrap;margin-right:-.5rem;margin-left:-.5rem}.row.reverse{-webkit-box-orient:horizontal;-webkit-box-direction:reverse;-ms-flex-direction:row-reverse;flex-direction:row-reverse}.col.reverse{-webkit-box-orient:vertical;-webkit-box-direction:reverse;-ms-flex-direction:column-reverse;flex-direction:column-reverse}.col-xs,.col-xs-1,.col-xs-10,.col-xs-11,.col-xs-12,.col-xs-2,.col-xs-3,.col-xs-4,.col-xs-5,.col-xs-6,.col-xs-7,.col-xs-8,.col-xs-9,.col-xs-offset-0,.col-xs-offset-1,.col-xs-offset-10,.col-xs-offset-11,.col-xs-offset-12,.col-xs-offset-2,.col-xs-offset-3,.col-xs-offset-4,.col-xs-offset-5,.col-xs-offset-6,.col-xs-offset-7,.col-xs-offset-8,.col-xs-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-xs{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-xs-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-xs-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-xs-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-xs-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-xs-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-xs-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-xs-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-xs-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-xs-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-xs-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-xs-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-xs-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-xs-offset-0{margin-left:0}.col-xs-offset-1{margin-left:8.33333333%}.col-xs-offset-2{margin-left:16.66666667%}.col-xs-offset-3{margin-left:25%}.col-xs-offset-4{margin-left:33.33333333%}.col-xs-offset-5{margin-left:41.66666667%}.col-xs-offset-6{margin-left:50%}.col-xs-offset-7{margin-left:58.33333333%}.col-xs-offset-8{margin-left:66.66666667%}.col-xs-offset-9{margin-left:75%}.col-xs-offset-10{margin-left:83.33333333%}.col-xs-offset-11{margin-left:91.66666667%}.start-xs{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-xs{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-xs{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-xs{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-xs{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-xs{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-xs{-ms-flex-pack:distribute;justify-content:space-around}.between-xs{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-xs{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-xs{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}@media only screen and (min-width:48em){.container{width:49rem}.col-sm,.col-sm-1,.col-sm-10,.col-sm-11,.col-sm-12,.col-sm-2,.col-sm-3,.col-sm-4,.col-sm-5,.col-sm-6,.col-sm-7,.col-sm-8,.col-sm-9,.col-sm-offset-0,.col-sm-offset-1,.col-sm-offset-10,.col-sm-offset-11,.col-sm-offset-12,.col-sm-offset-2,.col-sm-offset-3,.col-sm-offset-4,.col-sm-offset-5,.col-sm-offset-6,.col-sm-offset-7,.col-sm-offset-8,.col-sm-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-sm{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-sm-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-sm-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-sm-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-sm-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-sm-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-sm-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-sm-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-sm-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-sm-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-sm-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-sm-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-sm-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-sm-offset-0{margin-left:0}.col-sm-offset-1{margin-left:8.33333333%}.col-sm-offset-2{margin-left:16.66666667%}.col-sm-offset-3{margin-left:25%}.col-sm-offset-4{margin-left:33.33333333%}.col-sm-offset-5{margin-left:41.66666667%}.col-sm-offset-6{margin-left:50%}.col-sm-offset-7{margin-left:58.33333333%}.col-sm-offset-8{margin-left:66.66666667%}.col-sm-offset-9{margin-left:75%}.col-sm-offset-10{margin-left:83.33333333%}.col-sm-offset-11{margin-left:91.66666667%}.start-sm{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-sm{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-sm{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-sm{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-sm{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-sm{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-sm{-ms-flex-pack:distribute;justify-content:space-around}.between-sm{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-sm{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-sm{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:64em){.container{width:65rem}.col-md,.col-md-1,.col-md-10,.col-md-11,.col-md-12,.col-md-2,.col-md-3,.col-md-4,.col-md-5,.col-md-6,.col-md-7,.col-md-8,.col-md-9,.col-md-offset-0,.col-md-offset-1,.col-md-offset-10,.col-md-offset-11,.col-md-offset-12,.col-md-offset-2,.col-md-offset-3,.col-md-offset-4,.col-md-offset-5,.col-md-offset-6,.col-md-offset-7,.col-md-offset-8,.col-md-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-md{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-md-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-md-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-md-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-md-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-md-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-md-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-md-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-md-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-md-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-md-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-md-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-md-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-md-offset-0{margin-left:0}.col-md-offset-1{margin-left:8.33333333%}.col-md-offset-2{margin-left:16.66666667%}.col-md-offset-3{margin-left:25%}.col-md-offset-4{margin-left:33.33333333%}.col-md-offset-5{margin-left:41.66666667%}.col-md-offset-6{margin-left:50%}.col-md-offset-7{margin-left:58.33333333%}.col-md-offset-8{margin-left:66.66666667%}.col-md-offset-9{margin-left:75%}.col-md-offset-10{margin-left:83.33333333%}.col-md-offset-11{margin-left:91.66666667%}.start-md{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-md{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-md{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-md{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-md{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-md{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-md{-ms-flex-pack:distribute;justify-content:space-around}.between-md{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-md{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-md{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}@media only screen and (min-width:75em){.container{width:76rem}.col-lg,.col-lg-1,.col-lg-10,.col-lg-11,.col-lg-12,.col-lg-2,.col-lg-3,.col-lg-4,.col-lg-5,.col-lg-6,.col-lg-7,.col-lg-8,.col-lg-9,.col-lg-offset-0,.col-lg-offset-1,.col-lg-offset-10,.col-lg-offset-11,.col-lg-offset-12,.col-lg-offset-2,.col-lg-offset-3,.col-lg-offset-4,.col-lg-offset-5,.col-lg-offset-6,.col-lg-offset-7,.col-lg-offset-8,.col-lg-offset-9{box-sizing:border-box;-webkit-box-flex:0;-ms-flex:0 0 auto;flex:none;padding-right:.5rem;padding-left:.5rem}.col-lg{-webkit-box-flex:1;-ms-flex-positive:1;flex-grow:1;-ms-flex-preferred-size:0;flex-basis:0;max-width:100%}.col-lg-1{-ms-flex-preferred-size:8.33333333%;flex-basis:8.33333333%;max-width:8.33333333%}.col-lg-2{-ms-flex-preferred-size:16.66666667%;flex-basis:16.66666667%;max-width:16.66666667%}.col-lg-3{-ms-flex-preferred-size:25%;flex-basis:25%;max-width:25%}.col-lg-4{-ms-flex-preferred-size:33.33333333%;flex-basis:33.33333333%;max-width:33.33333333%}.col-lg-5{-ms-flex-preferred-size:41.66666667%;flex-basis:41.66666667%;max-width:41.66666667%}.col-lg-6{-ms-flex-preferred-size:50%;flex-basis:50%;max-width:50%}.col-lg-7{-ms-flex-preferred-size:58.33333333%;flex-basis:58.33333333%;max-width:58.33333333%}.col-lg-8{-ms-flex-preferred-size:66.66666667%;flex-basis:66.66666667%;max-width:66.66666667%}.col-lg-9{-ms-flex-preferred-size:75%;flex-basis:75%;max-width:75%}.col-lg-10{-ms-flex-preferred-size:83.33333333%;flex-basis:83.33333333%;max-width:83.33333333%}.col-lg-11{-ms-flex-preferred-size:91.66666667%;flex-basis:91.66666667%;max-width:91.66666667%}.col-lg-12{-ms-flex-preferred-size:100%;flex-basis:100%;max-width:100%}.col-lg-offset-0{margin-left:0}.col-lg-offset-1{margin-left:8.33333333%}.col-lg-offset-2{margin-left:16.66666667%}.col-lg-offset-3{margin-left:25%}.col-lg-offset-4{margin-left:33.33333333%}.col-lg-offset-5{margin-left:41.66666667%}.col-lg-offset-6{margin-left:50%}.col-lg-offset-7{margin-left:58.33333333%}.col-lg-offset-8{margin-left:66.66666667%}.col-lg-offset-9{margin-left:75%}.col-lg-offset-10{margin-left:83.33333333%}.col-lg-offset-11{margin-left:91.66666667%}.start-lg{-webkit-box-pack:start;-ms-flex-pack:start;justify-content:flex-start;text-align:start}.center-lg{-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;text-align:center}.end-lg{-webkit-box-pack:end;-ms-flex-pack:end;justify-content:flex-end;text-align:end}.top-lg{-webkit-box-align:start;-ms-flex-align:start;align-items:flex-start}.middle-lg{-webkit-box-align:center;-ms-flex-align:center;align-items:center}.bottom-lg{-webkit-box-align:end;-ms-flex-align:end;align-items:flex-end}.around-lg{-ms-flex-pack:distribute;justify-content:space-around}.between-lg{-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}.first-lg{-webkit-box-ordinal-group:0;-ms-flex-order:-1;order:-1}.last-lg{-webkit-box-ordinal-group:2;-ms-flex-order:1;order:1}}</style><link href=/index.xml rel=alternate type=application/rss+xml title="lstolcman Today-I-Learned"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet></head><body><article class=post id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>lstolcman Today-I-Learned</a></div><div class=header-subtitle></div></header><div class="row end-md center-xs header-items"><div class=header-item><a href=https://github.com/lstolcman target=_blank>Github</a></div></div><div class="row end-xs"></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Cache'em all! - speeding up apt and other downloads in (not only) docker containers (2024 version)</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2024-02-12 23:07:00 +0200">12 Feb 2024</time></div><div class=col-xs-6></div></div></header><div class="post-content markdown-body"><p>When working on couple of <del>Dockerfiles</del>Containerfiles, I was having a situation when I had to clear
<del>docker</del>podman cache (for various reasons), and the indispensable step is to update or download certain
packages from apt. It is often long process, and I was thinking whether there&rsquo;s a way to speed it up or
optimize.</p><p>The results of the investigation are below:</p><h1 id=caching-apt-get-downloads>Caching apt get downloads</h1><p>There are two options of caching:</p><ul><li>mount cache</li><li>apt-cacher-ng</li></ul><h2 id=mount-cache>mount cache</h2><p>Docker mechanism to cache layers.</p><p>Dockerfile extract:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>RUN rm -f /etc/apt/apt.conf.d/docker-clean <span style=color:#75715e># needed in ubuntu to persist cache, otherwise the mount won&#39;t work!</span>
</span></span><span style=display:flex><span>RUN --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>cache,mode<span style=color:#f92672>=</span>0755,target<span style=color:#f92672>=</span>/var/cache/apt <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    apt-get update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -yqq --no-install-recommends <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    git gcc make <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> rm -rf /var/lib/apt/lists/*
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>...<span style=color:#f92672>]</span>
</span></span></code></pre></div><p>(<a href=https://vsupalov.com/buildkit-cache-mount-dockerfile/>https://vsupalov.com/buildkit-cache-mount-dockerfile/</a>)</p><h2 id=apt-cacher-ng>apt-cacher-ng</h2><p><code>Acquire::http::Proxy</code> is a config option to set up proxying in apt.
However, since it fails in case proxy is not available, an &ldquo;improved&rdquo; version was added - <code>Acquire::http::Proxy-Auto-Detect</code>.
<code>apt-cacher-ng</code> is a companion to this mechanism - the apt wopuld get pointed to <code>apt-cacher-ng</code> instance, but it will fall back to
original source if not available.</p><p><code>apt-cacher-ng</code> is a separate app, most probably running in separate container (or as quadlet).
The purpose of the app is to perform <em>man-in-the-middle</em> between apt and source servers.
It&rsquo;ll hold the copy of downloaded <code>.deb</code>. When the file does not exist, it would get downloaded from
the server. If it is requested again, it is retrieved from local cache, and we&rsquo;d get the speedup.</p><p>It is a nice addition to mount cache mechanism - even if the mount cache did not get hit, we&rsquo;d have files cached anyway.</p><p>Step by step tutorial how to configure:</p><ol><li>Create background service with name. Note the <code>--network=host</code> - the container will be in host network, which should be accessible
from the other containers.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker run --name apt-cacher-ng --init -d --restart<span style=color:#f92672>=</span>always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--network<span style=color:#f92672>=</span>host <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--volume /var/cache/apt-cacher-ng:/var/cache/apt-cacher-ng <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>sameersbn/apt-cacher-ng
</span></span></code></pre></div><p>you may want to execute it like</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker run --name apt-cacher-ng --init -d --restart<span style=color:#f92672>=</span>always <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--publish 3142:3142 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>--volume /var/cache/apt-cacher-ng:/var/cache/apt-cacher-ng <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>sameersbn/apt-cacher-ng
</span></span></code></pre></div><p>this won&rsquo;t not work, because the other containers are not in the same network</p><p>Check whether cacher works by visiting a page via browser - go to http://localhost:3142 and you should see a page.
(Replace localhost with ip of your container if needed, e.g. in case of wsl2 or vm).</p><p>Once you have cacher set up, lets create a Containerfile which will use it:</p><p>example <code>compose.yaml</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span>services:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  service-1:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#75715e># image: ubuntu</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    build:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      <span style=color:#75715e># dockerfile: Dockerfile</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      context: .<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    tty: true<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#75715e>#  commented out not needed</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#75715e># network_mode: bridge</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#75715e># hostname: service-2</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    <span style=color:#75715e># container_name: service-2</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    command: <span style=color:#e6db74>&#34; sleep 100000&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>    extra_hosts:<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>      - <span style=color:#e6db74>&#34;host.docker.internal:host-gateway&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Note the &ldquo;extra_hosts&rdquo; - this is the mechanism which will make sure the contaienr has access to hsot system</p><p>read more [1] [2]</p><p>example <code>Dockerfile</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> docker.io/python:3.11-bookworm</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get -q update <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -qy auto-apt-proxy <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    <span style=color:#f92672>&amp;&amp;</span> apt-get install -qy python3-pip git jq curl unzip gcc<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Note the important one: the <code>apt-get install auto-apt-proxy</code> is separate from installing other apps.
It is imporant, because the apps would be downloaded one by one, and then installed one by one.
Having it as separate command would install it. The subsequent command is going to use <code>apt-cacher-ng</code> because the script
will be present in the system.</p><p><a href=https://salsa.debian.org/debian/auto-apt-proxy>auto-pat-proxy source code</a></p><p>Refs:
[1] <a href=https://stackoverflow.com/questions/70725881/what-is-the-equivalent-of-add-host-host-docker-internalhost-gateway-in-a-comp>https://stackoverflow.com/questions/70725881/what-is-the-equivalent-of-add-host-host-docker-internalhost-gateway-in-a-comp</a>
[2] <a href=https://github.com/microsoft/docker/blob/master/docs/examples/apt-cacher-ng.md>https://github.com/microsoft/docker/blob/master/docs/examples/apt-cacher-ng.md</a>
[3] <a href=https://blog.packagecloud.io/using-apt-cacher-ng-with-ssl-tls/>https://blog.packagecloud.io/using-apt-cacher-ng-with-ssl-tls/</a>
[4] <a href=https://razinj.dev/build-and-run-apt-cacher-ng-proxy-in-docker/>https://razinj.dev/build-and-run-apt-cacher-ng-proxy-in-docker/</a>
[5] <a href=https://medium.com/@TimvanBaarsen/how-to-connect-to-the-docker-host-from-inside-a-docker-container-112b4c71bc66>https://medium.com/@TimvanBaarsen/how-to-connect-to-the-docker-host-from-inside-a-docker-container-112b4c71bc66</a></p><h1 id=caching-python-pip-andor-poetry>Caching python (pip) and/or poetry</h1><p>There are problems with caching pip. It is related to issues
<a href=https://github.com/pypa/pip/issues/6045>like</a>
<a href=https://stackoverflow.com/questions/67253141/python-pip-riority-order-with-index-url-and-extra-index-url>this</a></p><p>Basically, the problem is not yet resolved.</p><p>The best way to cache python installs is to do mount cache.</p><h2 id=mount-cache----pip>mount cache &ndash; pip</h2><p>Not yet there</p><p><a href=https://stackoverflow.com/questions/58018300/using-a-pip-cache-directory-in-docker-builds>https://stackoverflow.com/questions/58018300/using-a-pip-cache-directory-in-docker-builds</a></p><p><a href=https://pmac.io/2019/02/multi-stage-dockerfile-and-python-virtualenv/>https://pmac.io/2019/02/multi-stage-dockerfile-and-python-virtualenv/</a></p><h2 id=mount-cache----poetry>mount cache &ndash; poetry</h2><ol><li>configure poetry: <code>RUN poetry config cache-dir /var/cache/poetry-cache</code>
a. you can set env variable as well: <a href=https://python-poetry.org/docs/configuration/#cache-dir>https://python-poetry.org/docs/configuration/#cache-dir</a></li><li>install but prefix with (buildkit) mount entry: <code>RUN --mount=type=cache,mode=0755,target=/var/cache/poetry-cache poetry install</code></li><li>it should work after rebuild with <code>--no-cache</code>.</li></ol><p>poetry setup for docker
<a href=https://github.com/orgs/python-poetry/discussions/1879#discussioncomment-216865>https://github.com/orgs/python-poetry/discussions/1879#discussioncomment-216865</a>
<a href=https://github.com/python-poetry/poetry/issues/525#issuecomment-1227231432>https://github.com/python-poetry/poetry/issues/525#issuecomment-1227231432</a></p><h1 id=other-stuff-to-be-cleaned-up-later>Other stuff, to be cleaned up later</h1><h1 id=-docker-multistage-builds># docker multistage builds</h1><p><a href=https://charlesxu.io/docker_multi_stage/>https://charlesxu.io/docker_multi_stage/</a></p><p><a href=https://medium.com/@tonistiigi/advanced-multi-stage-build-patterns-6f741b852fae>https://medium.com/@tonistiigi/advanced-multi-stage-build-patterns-6f741b852fae</a></p><p><a href=https://www.gasparevitta.com/posts/advanced-docker-multistage-parallel-build-buildkit/>https://www.gasparevitta.com/posts/advanced-docker-multistage-parallel-build-buildkit/</a></p><p><a href=https://pythonspeed.com/articles/multi-stage-docker-python/>https://pythonspeed.com/articles/multi-stage-docker-python/</a></p><h2 id=buildkit-cache-mounts>buildkit cache mounts</h2><p><a href=https://dev.doroshev.com/blog/docker-mount-type-cache/>https://dev.doroshev.com/blog/docker-mount-type-cache/</a></p><p>mode=0755 needed problem:</p><p><a href=https://github.com/moby/buildkit/issues/2447>https://github.com/moby/buildkit/issues/2447</a></p><p><a href=https://stackoverflow.com/questions/61459775/docker-buildkit-mount-type-cache-not-working-why>https://stackoverflow.com/questions/61459775/docker-buildkit-mount-type-cache-not-working-why</a></p><p><a href=https://docs.docker.com/build/cache/>https://docs.docker.com/build/cache/</a></p><p><a href=https://forums.docker.com/t/how-to-delete-build-cache-buildkit-experimental/70714>https://forums.docker.com/t/how-to-delete-build-cache-buildkit-experimental/70714</a></p><p><a href=https://github.com/moby/buildkit/issues/3155>https://github.com/moby/buildkit/issues/3155</a></p><p>mount type cache in depth
<a href=https://github.com/moby/buildkit/issues/1673>https://github.com/moby/buildkit/issues/1673</a></p><p>docker network ping by hostname between containers</p><p>default bridge - d not work
user defined bridge network - can access via hostname because there is a dns server
<a href=https://stackoverflow.com/a/53364345>https://stackoverflow.com/a/53364345</a></p><p>docker compose for testing the cache</p><p>services:
service-1:
image: busybox
# container_name: service-1
# hostname: service-1
network_mode: bridge
command: &ldquo;ping service-2&rdquo;
extra_hosts:
- &ldquo;host.docker.internal:host-gateway&rdquo;
service-2:
image: ubuntu
tty: true
network_mode: bridge
# hostname: service-2
# container_name: service-2
command: &ldquo;ping service-1&rdquo;
extra_hosts:
- &ldquo;host.docker.internal:host-gateway&rdquo;</p><p>networks:
mynet:
driver: bridge</p><p><a href=https://stackoverflow.com/questions/31324981/how-to-access-host-port-from-docker-container/>https://stackoverflow.com/questions/31324981/how-to-access-host-port-from-docker-container/</a>
<a href=https://medium.com/@TimvanBaarsen/how-to-connect-to-the-docker-host-from-inside-a-docker-container-112b4c71bc66>https://medium.com/@TimvanBaarsen/how-to-connect-to-the-docker-host-from-inside-a-docker-container-112b4c71bc66</a>
<a href=https://www.howtogeek.com/devops/how-to-connect-to-localhost-within-a-docker-container/>https://www.howtogeek.com/devops/how-to-connect-to-localhost-within-a-docker-container/</a></p><p><a href=https://docs.docker.com/storage/bind-mounts/>https://docs.docker.com/storage/bind-mounts/</a> mount type=cache missing in examples</p><p>and service-1 can ping to host by: ping host.docker.interal
so that, it can access the apt cacher instance available at (localhost):3142 -> host.docker.internal:3142
however, it needs to be specified first:</p></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/tags/python/>python</a></div><div class=post-tags><a href=/tags/apt/>apt</a></div><div class=post-tags><a href=/tags/pip/>pip</a></div><div class=post-tags><a href=/tags/docker/>docker</a></div><div class=post-tags><a href=/tags/podman/>podman</a></div></div></div><div class=row><div class=col-xs-12></div></div><div class=related-content><h3>Related Posts</h3><ul><li><a href=/post/pip-multiple-packages/>Installation speed of multiple python packages using pip</a></li><li><a href=/post/podman-compose-wsl2-ubuntu-22-04/>podman and docker-compose in Ubuntu 22.04.3 (WSL2)</a></li><li><a href=/post/podman-compile/>Podman compiling from source</a></li></ul></div><div style=height:50px></div><div class=site-footer></div></div></div></article><script></script></body></html>